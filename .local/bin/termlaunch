#!/usr/bin/env bash
set -euf -o pipefail


__USAGE="Usage: $(basename "$0") [OPTIONS] COMMAND

Launch the given command in a new terminal window.

Commands:
  scratchpad  Open a temporary file in a text editor, copying its contents to
              the system clipboard after saving.
  wiki        Open the wiki.
  calculator  Launch calculator.

Options:
  -g TEXT  X11 geometry string provided to floating windows.
  -h       Show this message and exit."


GEOMETRY=""


tl() {
  local args=()
  local class="$1"
  shift

  if [[ -n "${GEOMETRY}" ]]; then
    args+=(-g "${GEOMETRY}" -i)
  fi

  args+=(-c "${class}" -e "${SHELL}" -l -c "'$@'")
  eval "${TERMINAL} ${args[*]}"
}

tl_scratchpad() {
  local tmpfile
  tmpfile=$(mktemp)
  local command=("${EDITOR}" -c "startinsert" "${tmpfile}")
  tl "scratchpad" "${command[@]}" && xclip -selection clipboard < "${tmpfile}"
}

tl_wiki() {
  local command=("${EDITOR}" -c VimwikiIndex)
  tl "wiki" "${command[@]}"
}

tl_calculator() {
  local command=("bc" "-l" "-q")
  tl "calculator" "${command[@]}"
}


while getopts "hg:" arg; do
  case "${arg}" in
    h) echo "${__USAGE}"; exit 0 ;;
    g) GEOMETRY="${OPTARG}" ;;
    *) echo "${__USAGE}"; exit 1 ;;
  esac
done

case "${@:${OPTIND}:1}" in
  scratchpad) tl_scratchpad ;;
  wiki) tl_wiki ;;
  calculator) tl_calculator ;;
  *) echo "${__USAGE}"; exit 1 ;;
esac

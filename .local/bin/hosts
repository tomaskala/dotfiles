#!/usr/bin/env bash
set -euf -o pipefail


usage="Usage: $(basename "$0") [OPTIONS]

Options:
  -b FILE  Path to a blacklist file with 1 address per line.
           The file may contain comment lines beginning with '#'
           as well as empty lines. The addresses are assumed not
           to begin with a 'www.'. In turn, the script blocks both
           the given as well as 'www.'-prepended variants.
  -s FILE  Path to a lookup file with 1 address per line.
           The file may contain comment lines beginning with '#'
           as well as empty lines.
  -d TEXT  Address of a DNS server to use when digging the lookup file contents.
           If not beginning with '@', the character will be substituted.
  -h       Show this message and exit."


hosts_src="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts"
blacklist_src=""
lookup_src=""
dns=""


die() {
  >&2 echo "$1"
  exit 1
}


# Process arguments.
while getopts "hb:s:d:" arg; do
  case "${arg}" in
    h) echo "${usage}"; exit 0 ;;
    b) blacklist_src="${OPTARG}" ;;
    s) lookup_src="${OPTARG}" ;;
    d) dns="${OPTARG}" ;;
    *) echo "${usage}"; exit 1 ;;
  esac
done

# Check the argument values.
if [[ -n "${lookup_src}" ]] && ! type dig > /dev/null; then
  die "Dig is not installed."
fi

if [[ -n "${lookup_src}" ]] && [[ ! -f "${lookup_src}" ]]; then
  die "The file ${lookup_src} does not exist."
fi

if [[ -n "${blacklist_src}" ]] && [[ ! -f "${blacklist_src}" ]]; then
  die "The file ${blacklist_src} does not exist."
fi

if [[ "${dns#@}" == "${dns}" ]]; then
  dns="@${dns}"
fi

# Download the base hosts file.
sudo wget -O "/etc/hosts" "${hosts_src}" && sync

# Append dns lookups of internal services.
if [[ -n "${lookup_src}" ]]; then
  echo "# DNS lookup from the 'hosts' script." | sudo tee -a /etc/hosts

  while read -r addr; do
    if [[ -z "${addr}" ]]; then
      continue
    fi

    if [[ "${addr#\#}" == "${addr}" ]]; then
      lookup=$(dig "${addr}" "${dns}" +short)
      echo "${lookup} ${addr}" | sudo tee -a /etc/hosts
    else
      echo "${addr}" | sudo tee -a /etc/hosts
    fi
  done < "${lookup_src}"
fi

# Append the blacklist no-ops.
if [[ -n "${blacklist_src}" ]]; then
  echo "# Blacklist from the 'hosts' script." | sudo tee -a /etc/hosts

  while read -r addr; do
    if [[ -z "${addr}" ]]; then
      continue
    fi

    if [[ "${addr#\#}" == "${addr}" ]]; then
      echo "0.0.0.0 ${addr}" | sudo tee -a /etc/hosts
      echo "0.0.0.0 www.${addr}" | sudo tee -a /etc/hosts
    else
      echo "${addr}" | sudo tee -a /etc/hosts
    fi
  done < "${blacklist_src}"
fi

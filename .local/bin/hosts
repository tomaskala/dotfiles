#!/usr/bin/env bash
set -euf -o pipefail


__USAGE="Usage: $(basename "$0") [OPTIONS]

Options:
  -b FILE  Path to a blacklist file with 1 address per line.
           The file may contain comment lines beginning with '#'
           as well as empty lines. The addresses are assumed not
           to begin with a 'www.'. In turn, the script blocks both
           the given as well as 'www.'-prepended variants.
  -s FILE  Path to a lookup file with 1 address per line.
           The file may contain comment lines beginning with '#'
           as well as empty lines.
  -d TEXT  Address of a DNS server to use when digging the lookup file contents.
           If not beginning with '@', the character will be substituted.
  -h       Show this message and exit."


HOSTS_SRC="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn/hosts"
BLACKLIST_SRC=""
LOOKUP_SRC=""
DNS=""


function die {
  >&2 echo "$1"
  exit 1
}


# Process arguments.
while getopts "hb:s:d:" arg; do
  case "${arg}" in
    h) echo "${__USAGE}"; exit 0 ;;
    b) BLACKLIST_SRC="${OPTARG}" ;;
    s) LOOKUP_SRC="${OPTARG}" ;;
    d) DNS="${OPTARG}" ;;
    *) echo "${__USAGE}"; exit 1 ;;
  esac
done

# Check the argument values.
if [[ -n "${LOOKUP_SRC}" ]] && ! type dig > /dev/null; then
  die "The dig command is not installed." 
fi

if [[ -n "${LOOKUP_SRC}" ]] && [[ ! -f "${LOOKUP_SRC}" ]]; then
  die "The file ${LOOKUP_SRC} does not exist."
fi

if [[ -n "${BLACKLIST_SRC}" ]] && [[ ! -f "${BLACKLIST_SRC}" ]]; then
  die "The file ${BLACKLIST_SRC} does not exist."
fi

if [[ "${DNS#@}" == "${DNS}" ]]; then
  DNS="@${DNS}"
fi

# Download the base hosts file.
sudo wget -O "/etc/hosts" "${HOSTS_SRC}" && sync

# Append DNS lookups of internal services.
if [[ -n "${LOOKUP_SRC}" ]]; then
  echo "# DNS lookup from the 'hosts' script." | sudo tee -a /etc/hosts

  while read -r addr; do
    if [[ -z "${addr}" ]]; then
      continue
    fi

    if [[ "${addr#\#}" == "${addr}" ]]; then
      lookup=$(dig "${addr}" "${DNS}" +short)
      echo "${lookup} ${addr}" | sudo tee -a /etc/hosts
    else
      echo "${addr}" | sudo tee -a /etc/hosts
    fi
  done < "${LOOKUP_SRC}"
fi

# Append the blacklist no-ops.
if [[ -n "${BLACKLIST_SRC}" ]]; then
  echo "# Blacklist from the 'hosts' script." | sudo tee -a /etc/hosts

  while read -r addr; do
    if [[ -z "${addr}" ]]; then
      continue
    fi

    if [[ "${addr#\#}" == "${addr}" ]]; then
      echo "0.0.0.0 ${addr}" | sudo tee -a /etc/hosts
      echo "0.0.0.0 www.${addr}" | sudo tee -a /etc/hosts
    else
      echo "${addr}" | sudo tee -a /etc/hosts
    fi
  done < "${BLACKLIST_SRC}"
fi

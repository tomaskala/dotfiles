#!/usr/bin/env bash
set -eufo pipefail

LOCATION_STORE=~/.local/share/player-one/location

fzf_command() {
  fzf -d '/' +m --color=bw --reverse --border \
    --bind 'ctrl-h:reload(mpc ls {..-3})+clear-query' \
    --bind 'ctrl-l:reload(mpc ls {})+clear-query' \
    --bind 'ctrl-d:half-page-down' \
    --bind 'ctrl-u:half-page-up' \
    --bind "enter:execute-silent(mpc_play {} {n})+execute(printf '%s\n' {..-2} > ${LOCATION_STORE})+abort" \
    --bind 'ctrl-p:execute-silent(mpc toggle)' \
    --bind 'ctrl-s:execute-silent(mpc stop)' \
    --bind 'pgup:execute-silent(mpc prev)' \
    --bind 'pgdn:execute-silent(mpc next)' \
    --bind 'left:execute-silent(mpc seek -00:00:05)' \
    --bind 'right:execute-silent(mpc seek +00:00:05)' \
    --bind 'down:execute-silent(mpc volume -5)' \
    --bind 'up:execute-silent(mpc volume +5)' \
    --bind '=:execute-silent(mpc volume 100)' \
    --bind 'ctrl-r:execute-silent(mpc update)'
}

init_store() {
  store_dir=$(dirname "${LOCATION_STORE}")
  mkdir -p "${store_dir}"
  touch "${LOCATION_STORE}"
}

mpc_play() {
  if [ "${1%.mp3}" = "$1" -a "${1%.flac}" = "$1" ]; then
    album="$1"
    first=1
  else
    album=$(dirname "$1")
    first=$(($2 + 1))
  fi

  mpc stop
  mpc clear
  mpc add "${album}"
  mpc play "${first}"
}

export -f mpc_play

mpc repeat on
mpc consume on

init_store
location=$(cat "${LOCATION_STORE}")
mpc ls "${location}" | fzf_command
